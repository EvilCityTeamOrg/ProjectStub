<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link rel="stylesheet" href="stylesheet.css">
    <title>Вход</title>
</head>

<body class="position-relative h-100vh" style="background-color: #e6e6e6;">
    <div id="content" style="padding-inline: 10px;">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
    </div>

    <script>
        const query = new URL(window.location).searchParams;
        fetch("./user/get").then((res) => {
            if (res.status == 401) {
                window.location = './login.html';
            }
            res.json().then((json) => {
                document.getElementById('content').innerHTML = `
                <h1 style="text-align: center;">${json.username}</h1>
                <br>
                <h3>Недавние заказы:</h3>
                <div id="content-orders">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <h3>Купоны:</h3>
                <div id="content-bonuses">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                `;
                fetch('./orders').then((res) => {
                    res.json().then((json) => {
                        let html = "<div style=\"display: flex; flex-direction: column;\">";
                        json.values.forEach(element => {
                            const sp = element.text.split('|');
                            html += `
                            <div class="order"><h5 class="card-title">${sp[0]}</h5><ul>
                            `;
                            sp.splice(0, 1);
                            sp.forEach(e => {
                                html += `<li>${e}</li>`
                            })
                            html += `</ul></div>`;
                        });
                        document.getElementById('content-orders').innerHTML = html + "</div>";
                        fetch("./bonuses/receive").then((res) => {
                            res.json().then((json) => {
                                let html = "<div style=\"display: flex; flex-direction: column;\">";
                                json.values.push({
                                    uid: "42766bb5-c682-499e-afc7-15a13cf75d6d",
                                    name: "Скидка 50%"
                                });
                                json.values.forEach(element => {
                                    html += `
                                    <div class="bonus"><h5 class="card-title">${element.name}</h5>
                                        <img onclick="window.location = './qr.html?uid=${element.uid}';" src="https://api.qrserver.com/v1/create-qr-code/?data=${element.uid}&size=300x300">
                                        <small>Нажмите на QR код чтобы приблизить</small>
                                    </div>
                                    `;
                                });
                                document.getElementById('content-bonuses').innerHTML = html + "</div>";
                            }).catch(err => {
                                console.error(err);
                                window.location = "./fail.html";
                            })
                        }).catch(err => {
                            console.error(err);
                            window.location = "./fail.html";
                        });
                    }).catch(err => {
                        console.error(err);
                        window.location = "./fail.html";
                    })
                }).catch(err => {
                    console.error(err);
                    window.location = "./fail.html";
                })
            }).catch(err => {
                console.error(err);
                window.location = "./fail.html";
            })
        }).catch(err => {
            console.error(err);
            window.location = "./fail.html";
        })
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
        crossorigin="anonymous"></script>
</body>

</html>